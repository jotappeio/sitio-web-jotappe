name: Centinela de Seguridad Jotappe.io

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  security-patrol:
    runs-on: ubuntu-latest
    steps:
      - name: Verificar Estado del Sitio
        id: check_status
        run: |
          # El flag -L permite seguir la redirecci√≥n 307 hasta el c√≥digo 200 final
          STATUS=$(curl -o /dev/null -s -L -w "%{http_code}\n" https://jotappe.com)
          echo "STATUS_CODE=$STATUS" >> $GITHUB_ENV
          
          # Ahora verificamos si el c√≥digo final es 200 tras seguir los saltos
          if [ "$STATUS" -ne 200 ]; then
            echo "ALERT=TRUE" >> $GITHUB_ENV
          else
            echo "ALERT=FALSE" >> $GITHUB_ENV
          fi

      - name: Verificar Certificado SSL
        id: check_ssl
        run: |
          # Optimizamos la captura para extraer solo la fecha de vencimiento
          EXPIRY=$(echo | openssl s_client -servername jotappe.com -connect jotappe.com:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
          echo "SSL_EXPIRY=$EXPIRY" >> $GITHUB_ENV

      - name: Enviar Alerta Roja a Telegram
        if: env.ALERT == 'TRUE'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üö® ALERTA DE SEGURIDAD JOTAPPE.IO üö®
            
            ‚ö†Ô∏è INCIDENCIA CR√çTICA DETECTADA
            --------------------------------
            ‚ùå Estado Web: CA√çDO (C√≥digo ${{ env.STATUS_CODE }})
            üõ°Ô∏è SSL Check (Vence): ${{ env.SSL_EXPIRY }}
            
            Protocolo: Revisar Vercel inmediatamente.

      - name: Reporte de Rutina (Si todo est√° OK)
        if: env.ALERT == 'FALSE'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚úÖ REPORTE CENTINELA JOTAPPE.COM
            
            El sitio opera con normalidad.
            Estado: 100% Operativo (C√≥digo 200)
            Blindaje SSL: Activo hasta ${{ env.SSL_EXPIRY }}
