name: Centinela de Seguridad Jotappe.io

on:
  schedule:
    - cron: '0 */6 * * *' # Ejecutar cada 6 horas
  workflow_dispatch: # Permite ejecutarlo manualmente bot√≥n

jobs:
  security-patrol:
    runs-on: ubuntu-latest
    steps:
      - name: Verificar Estado del Sitio
        id: check_status
        run: |
          STATUS=$(curl -o /dev/null -s -w "%{http_code}\n" https://jotappe.com)
          echo "STATUS_CODE=$STATUS" >> $GITHUB_ENV
          if [ "$STATUS" -ne 200 ]; then
            echo "ALERT=TRUE" >> $GITHUB_ENV
          else
            echo "ALERT=FALSE" >> $GITHUB_ENV
          fi

      - name: Verificar Certificado SSL
        id: check_ssl
        run: |
          EXPIRY=$(echo | openssl s_client -servername jotappe.com -connect jotappe.com:443 2>/dev/null | openssl x509 -noout -enddate)
          echo "SSL_EXPIRY=$EXPIRY" >> $GITHUB_ENV

      - name: Enviar Alerta Roja a Telegram
        if: env.ALERT == 'TRUE'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üö® ALERTA DE SEGURIDAD JOTAPPE.IO üö®
            
            ‚ö†Ô∏è INCIDENCIA CR√çTICA DETECTADA
            --------------------------------
            ‚ùå Estado Web: CA√çDO (C√≥digo ${{ env.STATUS_CODE }})
            üõ°Ô∏è SSL Check: ${{ env.SSL_EXPIRY }}
            
            Protocolo: Revisar Vercel inmediatamente.

      - name: Reporte de Rutina (Si todo est√° OK)
        if: env.ALERT == 'FALSE'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚úÖ REPORTE CENTINELA
            
            El sitio jotappe.com opera con normalidad.
            Estado: 100% Operativo
            Blindaje: Activo
